 version: '2.4'

services:
    redis:
        image: redis:alpine

    db:
        image: mariadb:10.4
        working_dir: /application
        command: [mysqld, --character-set-server=utf8mb4, --collation-server=utf8mb4_unicode_ci, --innodb-file-format=Barracuda, --innodb-large-prefix=1, --innodb-file-per-table=1]
        environment:
            - MYSQL_ROOT_PASSWORD=pimcore
            - MYSQL_DATABASE=pimcore_test
            - MYSQL_USER=pimcore
            - MYSQL_PASSWORD=pimcore

    php:
        image: docker-repository.intern.neusta.de:18443/pimcore/php:7.4.8-fpm-alpine3.12-dev
        volumes:
            - .:/var/www/pimcore:cached
        hostname: pimcore-test.dev
        depends_on:
          - db
          - redis
        environment:
            - COMPOSER_MEMORY_LIMIT=-1
            - TASK_TESTS=1
            - TASK_STAN=0
            - TASK_DOCS=0
            - PHPSTAN_LEVEL=3
            - PHPSTAN_BASELINE=1
            - PHPSTAN_BASELINE_GENERATE=0
            - PIMCORE_ENVIRONMENT=test
            - PIMCORE_TEST=1
            - PIMCORE_TEST_URL=http://pimcore-test.dev
            - PIMCORE_TEST_DB_DSN="mysql://root:pimcore@db/pimcore_test"
            - PIMCORE_TEST_CACHE_REDIS_DATABASE=1
            - SYMFONY_VERSION=^4.0
            - PIMCORE_PROJECT_ROOT=/var/www/pimcore
            - PIMCORE_PHP_ERROR_REPORTING=32767 # E_ALL
